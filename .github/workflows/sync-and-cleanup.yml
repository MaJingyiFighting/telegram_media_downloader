name: åŒæ­¥ä¸Šæ¸¸ä»£ç å¹¶æ¸…ç†é•œåƒ

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 3 ç‚¹è¿è¡Œ
    - cron: '0 3 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  packages: write

jobs:
  sync-upstream:
    name: ä¸ä¸Šæ¸¸ä»“åº“åŒæ­¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
      
      - name: é…ç½®Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        run: |
          git remote add upstream https://github.com/tangyoha/telegram_media_downloader.git
          git fetch upstream
      
      - name: åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        run: |
          git checkout master
          git merge upstream/master -m "ğŸ¤– è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ä»“åº“æ›´æ–°"
      
      - name: æ¨é€æ›´æ–°
        run: |
          git push origin master

  cleanup-images:
    name: æ¸…ç†Dockeré•œåƒï¼ˆä»…ä¿ç•™latestï¼‰
    runs-on: ubuntu-latest
    needs: sync-upstream
    steps:
      - name: å®‰è£…jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ç™»å½•åˆ°GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½®lowercaseä»“åº“æ‰€æœ‰è€…
        id: lowercase
        run: |
          echo "repository_owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: è·å–å¹¶æ¸…ç†æ‰€æœ‰élatesté•œåƒ
        run: |
          # ä½¿ç”¨GitHub APIè·å–å®¹å™¨é•œåƒåˆ—è¡¨
          PACKAGE_NAME="telegram_media_downloader"
          REPO_OWNER="${{ env.repository_owner_lc }}"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨æ‰€æœ‰ç‰ˆæœ¬ID
          touch all_versions.txt
          
          # åˆå§‹åŒ–é¡µç å’Œæ ‡å¿—
          PAGE=1
          HAS_MORE=true
          TOTAL_VERSIONS=0
          
          echo "å¼€å§‹è·å–æ‰€æœ‰é•œåƒç‰ˆæœ¬ä¿¡æ¯..."
          
          # ä½¿ç”¨å¾ªç¯è·å–æ‰€æœ‰é¡µé¢çš„ç‰ˆæœ¬
          while [ "$HAS_MORE" = "true" ]; do
            echo "æ­£åœ¨è·å–ç¬¬ $PAGE é¡µé•œåƒç‰ˆæœ¬..."
            
            # è·å–å½“å‰é¡µçš„ç‰ˆæœ¬åˆ—è¡¨
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/user/packages/container/${PACKAGE_NAME}/versions?per_page=100&page=${PAGE}")
            
            # è§£æå“åº”ä¸­çš„ç‰ˆæœ¬ID
            CURRENT_PAGE_VERSIONS=$(echo "$RESPONSE" | jq -r '.[] | .id')
            VERSIONS_COUNT=$(echo "$CURRENT_PAGE_VERSIONS" | grep -v '^$' | wc -l)
            
            # å¦‚æœå½“å‰é¡µæœ‰ç‰ˆæœ¬ï¼Œåˆ™æ·»åŠ åˆ°æ–‡ä»¶ä¸­
            if [ "$VERSIONS_COUNT" -gt 0 ]; then
              echo "$CURRENT_PAGE_VERSIONS" >> all_versions.txt
              TOTAL_VERSIONS=$((TOTAL_VERSIONS + VERSIONS_COUNT))
              echo "ç¬¬ $PAGE é¡µæ‰¾åˆ° $VERSIONS_COUNT ä¸ªç‰ˆæœ¬"
              # ç»§ç»­æ£€æŸ¥ä¸‹ä¸€é¡µ
              PAGE=$((PAGE + 1))
            else
              # å¦‚æœå½“å‰é¡µæ²¡æœ‰ç‰ˆæœ¬ï¼Œè¯´æ˜å·²ç»è·å–å®Œæ¯•
              HAS_MORE=false
              echo "æ²¡æœ‰æ›´å¤šé¡µé¢ï¼Œé•œåƒç‰ˆæœ¬è·å–å®Œæ¯•"
            fi
          done
          
          echo "å…±æ‰¾åˆ° $TOTAL_VERSIONS ä¸ªé•œåƒç‰ˆæœ¬"
          
          # è®°å½•è¦ä¿ç•™å’Œåˆ é™¤çš„æ•°é‡
          KEPT=0
          DELETED=0
          
          # éå†æ‰€æœ‰ç‰ˆæœ¬ï¼Œåªä¿ç•™latestæ ‡ç­¾çš„é•œåƒ
          while read -r VERSION_ID; do
            # è·³è¿‡ç©ºè¡Œ
            if [ -z "$VERSION_ID" ]; then
              continue
            fi
            
            # è·å–é•œåƒçš„æ ‡ç­¾ä¿¡æ¯
            VERSION_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/user/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}")
            
            # æ£€æŸ¥æ ‡ç­¾åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«"latest"
            HAS_LATEST=$(echo "$VERSION_INFO" | jq -r '.metadata.container.tags | indices("latest") | length > 0')
            
            if [ "$HAS_LATEST" = "true" ]; then
              echo "ä¿ç•™latestæ ‡ç­¾é•œåƒï¼Œç‰ˆæœ¬ID: ${VERSION_ID}"
              KEPT=$((KEPT + 1))
            else
              echo "åˆ é™¤élatesté•œåƒï¼Œç‰ˆæœ¬ID: ${VERSION_ID}"
              curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/user/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}"
              DELETED=$((DELETED + 1))
              
              # æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIé™åˆ¶
              sleep 0.5
            fi
          done < all_versions.txt
          
          echo "é•œåƒæ¸…ç†å®Œæˆï¼Œä¿ç•™ $KEPT ä¸ªé•œåƒï¼Œåˆ é™¤ $DELETED ä¸ªé•œåƒ" 
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f all_versions.txt 